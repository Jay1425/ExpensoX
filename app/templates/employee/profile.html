{% extends "base.html" %}

{% block title %}My Profile{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .avatar-circle {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: bold;
        background: rgba(255,255,255,0.2);
        border: 3px solid rgba(255,255,255,0.3);
    }
    .info-section {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .info-section h6 {
        color: #495057;
        border-bottom: 2px solid #007bff;
        padding-bottom: 0.5rem;
        margin-bottom: 1rem;
    }
    .stat-card {
        border-left: 4px solid;
        transition: transform 0.2s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
    }
    .edit-mode .form-control {
        border-color: #007bff;
    }
    .profile-completion {
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }
    .profile-completion-bar {
        height: 100%;
        background: linear-gradient(90deg, #28a745, #20c997);
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Profile Header -->
    <div class="profile-header">
        <div class="d-flex align-items-center">
            <div class="avatar-circle me-4">
                {{ current_user.first_name[0].upper() }}{{ current_user.last_name[0].upper() }}
            </div>
            <div class="flex-grow-1">
                <h1 class="h3 mb-1">{{ current_user.first_name }} {{ current_user.last_name }}</h1>
                <p class="mb-2">{{ current_user.role.name.title() }} â€¢ {{ current_user.company.name }}</p>
                <div class="d-flex align-items-center">
                    <small class="opacity-75 me-3">Profile Completion</small>
                    <div class="profile-completion flex-grow-1 me-3" style="max-width: 200px;">
                        <div class="profile-completion-bar" style="width: 75%;"></div>
                    </div>
                    <small class="opacity-75">75%</small>
                </div>
            </div>
            <div>
                <button class="btn btn-light" id="editProfileBtn" onclick="toggleEditMode()">
                    <i class="fas fa-edit me-2"></i>Edit Profile
                </button>
                <button class="btn btn-success d-none" id="saveProfileBtn" onclick="saveProfile()">
                    <i class="fas fa-save me-2"></i>Save Changes
                </button>
                <button class="btn btn-outline-light d-none" id="cancelEditBtn" onclick="cancelEdit()">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <div class="row">
        <!-- Profile Information -->
        <div class="col-lg-8">
            <form method="POST" id="profileForm">
                <!-- Personal Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-user me-2"></i>Personal Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="first_name" class="form-label">First Name</label>
                                    <input type="text" class="form-control" id="first_name" name="first_name" 
                                           value="{{ current_user.first_name }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="last_name" class="form-label">Last Name</label>
                                    <input type="text" class="form-control" id="last_name" name="last_name" 
                                           value="{{ current_user.last_name }}" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="email" class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="email" name="email" 
                                           value="{{ current_user.email }}" readonly>
                                    <div class="form-text">
                                        <i class="fas fa-{{ 'check-circle text-success' if current_user.email_verified else 'exclamation-triangle text-warning' }} me-1"></i>
                                        {{ 'Verified' if current_user.email_verified else 'Not verified' }}
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="phone_number" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" 
                                           value="{{ profile.phone_number if profile else '' }}" 
                                           placeholder="+1 (555) 123-4567" readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Work Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-briefcase me-2"></i>Work Information
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="role" class="form-label">Role</label>
                                    <input type="text" class="form-control" id="role" 
                                           value="{{ current_user.role.name.title() }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="department" class="form-label">Department</label>
                                    <input type="text" class="form-control" id="department" name="department" 
                                           value="{{ profile.department if profile else '' }}" 
                                           placeholder="e.g., Engineering, Marketing" readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="company" class="form-label">Company</label>
                                    <input type="text" class="form-control" id="company" 
                                           value="{{ current_user.company.name }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="manager" class="form-label">Manager</label>
                                    <input type="text" class="form-control" id="manager" 
                                           value="{% if profile and profile.manager %}{{ profile.manager.first_name }} {{ profile.manager.last_name }}{% else %}Not assigned{% endif %}" 
                                           readonly>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="employee_id" class="form-label">Employee ID</label>
                                    <input type="text" class="form-control" id="employee_id" 
                                           value="{{ current_user.id }}" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="join_date" class="form-label">Join Date</label>
                                    <input type="text" class="form-control" id="join_date" 
                                           value="{{ current_user.created_at.strftime('%B %d, %Y') if current_user.created_at else 'N/A' }}" 
                                           readonly>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Preferences -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="mb-0">
                            <i class="fas fa-cog me-2"></i>Preferences
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="currency_preference" class="form-label">Preferred Currency</label>
                                    <select class="form-select" id="currency_preference" name="currency_preference" disabled>
                                        <option value="USD" selected>USD - US Dollar</option>
                                        <option value="EUR">EUR - Euro</option>
                                        <option value="GBP">GBP - British Pound</option>
                                        <option value="CAD">CAD - Canadian Dollar</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="timezone" class="form-label">Timezone</label>
                                    <select class="form-select" id="timezone" name="timezone" disabled>
                                        <option value="UTC-5" selected>Eastern Time (UTC-5)</option>
                                        <option value="UTC-6">Central Time (UTC-6)</option>
                                        <option value="UTC-7">Mountain Time (UTC-7)</option>
                                        <option value="UTC-8">Pacific Time (UTC-8)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Notification Preferences</label>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="email_notifications" 
                                               name="email_notifications" checked disabled>
                                        <label class="form-check-label" for="email_notifications">
                                            Email Notifications
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="expense_updates" 
                                               name="expense_updates" checked disabled>
                                        <label class="form-check-label" for="expense_updates">
                                            Expense Status Updates
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="approval_reminders" 
                                               name="approval_reminders" checked disabled>
                                        <label class="form-check-label" for="approval_reminders">
                                            Approval Reminders
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="weekly_summary" 
                                               name="weekly_summary" disabled>
                                        <label class="form-check-label" for="weekly_summary">
                                            Weekly Summary
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Quick Stats -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card stat-card border-primary">
                        <div class="card-body text-center">
                            <i class="fas fa-receipt fa-2x text-primary mb-2"></i>
                            <h4 class="text-primary mb-1">23</h4>
                            <small class="text-muted">Total Expenses</small>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row mb-4">
                <div class="col-6">
                    <div class="card stat-card border-success">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <h5 class="text-success mb-1">18</h5>
                            <small class="text-muted">Approved</small>
                        </div>
                    </div>
                </div>
                <div class="col-6">
                    <div class="card stat-card border-warning">
                        <div class="card-body text-center">
                            <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                            <h5 class="text-warning mb-1">5</h5>
                            <small class="text-muted">Pending</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Account Security -->
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Account Security
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">Two-Factor Authentication</h6>
                            <small class="text-muted">Add extra security to your account</small>
                        </div>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="twoFactor" 
                                   {{ 'checked' if current_user.two_factor_enabled else '' }}>
                        </div>
                    </div>
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div>
                            <h6 class="mb-1">Email Verification</h6>
                            <small class="text-{{ 'success' if current_user.email_verified else 'warning' }}">
                                {{ 'Verified' if current_user.email_verified else 'Not verified' }}
                            </small>
                        </div>
                        {% if not current_user.email_verified %}
                        <button class="btn btn-sm btn-outline-primary" onclick="resendVerification()">
                            Verify
                        </button>
                        {% else %}
                        <i class="fas fa-check-circle text-success"></i>
                        {% endif %}
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-outline-secondary btn-sm" onclick="changePassword()">
                            <i class="fas fa-key me-2"></i>Change Password
                        </button>
                    </div>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-history me-2"></i>Recent Activity
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-success rounded-circle p-2 me-3">
                            <i class="fas fa-plus text-white"></i>
                        </div>
                        <div>
                            <small class="fw-bold">Expense Submitted</small>
                            <div class="small text-muted">Office supplies - $45.00</div>
                            <div class="small text-muted">2 hours ago</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center mb-3">
                        <div class="bg-primary rounded-circle p-2 me-3">
                            <i class="fas fa-check text-white"></i>
                        </div>
                        <div>
                            <small class="fw-bold">Expense Approved</small>
                            <div class="small text-muted">Travel expenses - $250.00</div>
                            <div class="small text-muted">1 day ago</div>
                        </div>
                    </div>
                    <div class="d-flex align-items-center">
                        <div class="bg-info rounded-circle p-2 me-3">
                            <i class="fas fa-user text-white"></i>
                        </div>
                        <div>
                            <small class="fw-bold">Profile Updated</small>
                            <div class="small text-muted">Phone number changed</div>
                            <div class="small text-muted">3 days ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let isEditMode = false;

function toggleEditMode() {
    isEditMode = !isEditMode;
    
    const form = document.getElementById('profileForm');
    const inputs = form.querySelectorAll('input[type="text"], input[type="tel"], select');
    const checkboxes = form.querySelectorAll('input[type="checkbox"]');
    
    if (isEditMode) {
        // Enable edit mode
        inputs.forEach(input => {
            if (!input.id.includes('email') && !input.id.includes('role') && 
                !input.id.includes('company') && !input.id.includes('manager') && 
                !input.id.includes('employee_id') && !input.id.includes('join_date')) {
                input.removeAttribute('readonly');
                input.removeAttribute('disabled');
            }
        });
        
        checkboxes.forEach(checkbox => {
            if (!checkbox.id.includes('twoFactor')) {
                checkbox.removeAttribute('disabled');
            }
        });
        
        form.classList.add('edit-mode');
        document.getElementById('editProfileBtn').classList.add('d-none');
        document.getElementById('saveProfileBtn').classList.remove('d-none');
        document.getElementById('cancelEditBtn').classList.remove('d-none');
    } else {
        // Disable edit mode
        inputs.forEach(input => {
            input.setAttribute('readonly', 'readonly');
            input.setAttribute('disabled', 'disabled');
        });
        
        checkboxes.forEach(checkbox => {
            checkbox.setAttribute('disabled', 'disabled');
        });
        
        form.classList.remove('edit-mode');
        document.getElementById('editProfileBtn').classList.remove('d-none');
        document.getElementById('saveProfileBtn').classList.add('d-none');
        document.getElementById('cancelEditBtn').classList.add('d-none');
    }
}

function saveProfile() {
    const form = document.getElementById('profileForm');
    const formData = new FormData(form);
    
    // In a real implementation, this would submit the form
    form.submit();
}

function cancelEdit() {
    if (confirm('Discard all changes?')) {
        location.reload();
    }
}

function changePassword() {
    window.location.href = '{{ url_for("auth.settings") }}';
}

function resendVerification() {
    if (confirm('Send verification email?')) {
        // In a real implementation, this would trigger email verification
        alert('Verification email sent!');
    }
}

// Two-factor toggle
document.getElementById('twoFactor').addEventListener('change', function() {
    const enabled = this.checked;
    if (confirm(`${enabled ? 'Enable' : 'Disable'} two-factor authentication?`)) {
        // In a real implementation, this would update the setting
        console.log('2FA toggled:', enabled);
    } else {
        this.checked = !enabled;
    }
});
</script>
{% endblock %}