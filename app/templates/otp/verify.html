{% extends "base.html" %}

{% block title %}Verify Your Account - ExpensoX{% endblock %}

{% block extra_css %}
<style>
    .otp-container {
        max-width: 500px;
        margin: 50px auto;
    }
    
    .otp-input-group {
        display: flex;
        justify-content: center;
        gap: 15px;
        margin: 30px 0;
    }
    
    .otp-input {
        width: 50px;
        height: 60px;
        text-align: center;
        font-size: 24px;
        font-weight: bold;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        transition: all 0.3s;
    }
    
    .otp-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        outline: none;
    }
    
    .otp-input.error {
        border-color: #dc3545;
        animation: shake 0.5s;
    }
    
    @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
    
    .timer {
        font-size: 18px;
        font-weight: bold;
        color: #0d6efd;
    }
    
    .timer.warning {
        color: #fd7e14;
    }
    
    .timer.expired {
        color: #dc3545;
    }
    
    .verification-icon {
        font-size: 4rem;
        margin-bottom: 20px;
    }
    
    .verification-icon.signup { color: #198754; }
    .verification-icon.login { color: #0d6efd; }
    .verification-icon.password_reset { color: #fd7e14; }
    .verification-icon.two_factor { color: #6f42c1; }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="otp-container">
        <div class="card shadow">
            <div class="card-body text-center">
                <!-- Verification Icon -->
                <div class="verification-icon {{ otp_type }}">
                    {% if otp_type == 'signup' %}
                        <i class="fas fa-user-check"></i>
                    {% elif otp_type == 'login' %}
                        <i class="fas fa-shield-alt"></i>
                    {% elif otp_type == 'password_reset' %}
                        <i class="fas fa-key"></i>
                    {% elif otp_type == 'two_factor' %}
                        <i class="fas fa-lock"></i>
                    {% endif %}
                </div>
                
                <!-- Title and Description -->
                <h3 class="mb-3">
                    {% if otp_type == 'signup' %}
                        Verify Your Email
                    {% elif otp_type == 'login' %}
                        Two-Factor Authentication
                    {% elif otp_type == 'password_reset' %}
                        Reset Your Password
                    {% elif otp_type == 'two_factor' %}
                        Authentication Required
                    {% endif %}
                </h3>
                
                <p class="text-muted mb-4">
                    {% if otp_type == 'signup' %}
                        We've sent a 6-digit verification code to <strong>{{ user.email }}</strong>. 
                        Please enter the code below to complete your registration.
                    {% elif otp_type == 'login' %}
                        For your security, we've sent a verification code to <strong>{{ user.email }}</strong>. 
                        Please enter the code below to complete your login.
                    {% elif otp_type == 'password_reset' %}
                        We've sent a 6-digit verification code to <strong>{{ user.email }}</strong>. 
                        Please enter the code below to proceed with password reset.
                    {% elif otp_type == 'two_factor' %}
                        Please enter the 6-digit authentication code sent to <strong>{{ user.email }}</strong>.
                    {% endif %}
                </p>
                
                <!-- OTP Input Form -->
                <form id="otpForm">
                    <div class="otp-input-group">
                        <input type="text" class="otp-input" maxlength="1" id="otp1" tabindex="1">
                        <input type="text" class="otp-input" maxlength="1" id="otp2" tabindex="2">
                        <input type="text" class="otp-input" maxlength="1" id="otp3" tabindex="3">
                        <input type="text" class="otp-input" maxlength="1" id="otp4" tabindex="4">
                        <input type="text" class="otp-input" maxlength="1" id="otp5" tabindex="5">
                        <input type="text" class="otp-input" maxlength="1" id="otp6" tabindex="6">
                    </div>
                    
                    <div class="mb-4">
                        <button type="submit" class="btn btn-primary btn-lg" id="verifyBtn" disabled>
                            <i class="fas fa-check me-2"></i>Verify Code
                        </button>
                    </div>
                </form>
                
                <!-- Timer and Resend -->
                <div class="mb-3">
                    <p class="mb-2">Code expires in: <span class="timer" id="timer">10:00</span></p>
                    <button type="button" class="btn btn-outline-secondary" id="resendBtn" disabled>
                        <i class="fas fa-redo me-2"></i>Resend Code
                    </button>
                </div>
                
                <!-- Loading Indicator -->
                <div id="loadingIndicator" class="d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2 text-muted">Processing...</p>
                </div>
                
                <!-- Error Display -->
                <div id="errorAlert" class="alert alert-danger d-none" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
                
                <!-- Success Display -->
                <div id="successAlert" class="alert alert-success d-none" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <span id="successMessage"></span>
                </div>
                
                <!-- Help Text -->
                <div class="mt-4">
                    <small class="text-muted">
                        Didn't receive the code? Check your spam folder or 
                        <a href="#" id="contactSupport">contact support</a>.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const otpInputs = document.querySelectorAll('.otp-input');
    const verifyBtn = document.getElementById('verifyBtn');
    const resendBtn = document.getElementById('resendBtn');
    const timerElement = document.getElementById('timer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const errorAlert = document.getElementById('errorAlert');
    const successAlert = document.getElementById('successAlert');
    const errorMessage = document.getElementById('errorMessage');
    const successMessage = document.getElementById('successMessage');
    
    let timeRemaining = {{ otp_status.time_remaining or 600 }};
    let timerInterval;
    
    // OTP Input Handling
    otpInputs.forEach((input, index) => {
        input.addEventListener('input', function(e) {
            if (e.target.value.length === 1 && index < otpInputs.length - 1) {
                otpInputs[index + 1].focus();
            }
            checkOTPComplete();
        });
        
        input.addEventListener('keydown', function(e) {
            if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                otpInputs[index - 1].focus();
            }
        });
        
        input.addEventListener('paste', function(e) {
            e.preventDefault();
            const pastedData = e.clipboardData.getData('text');
            if (pastedData.length === 6 && /^\d{6}$/.test(pastedData)) {
                pastedData.split('').forEach((digit, idx) => {
                    if (idx < otpInputs.length) {
                        otpInputs[idx].value = digit;
                    }
                });
                checkOTPComplete();
            }
        });
    });
    
    function checkOTPComplete() {
        const otp = getOTPValue();
        verifyBtn.disabled = otp.length !== 6;
    }
    
    function getOTPValue() {
        return Array.from(otpInputs).map(input => input.value).join('');
    }
    
    function clearOTP() {
        otpInputs.forEach(input => {
            input.value = '';
            input.classList.remove('error');
        });
        otpInputs[0].focus();
        checkOTPComplete();
    }
    
    function showError(message) {
        errorMessage.textContent = message;
        errorAlert.classList.remove('d-none');
        successAlert.classList.add('d-none');
        
        // Add error animation to inputs
        otpInputs.forEach(input => input.classList.add('error'));
        setTimeout(() => {
            otpInputs.forEach(input => input.classList.remove('error'));
        }, 500);
    }
    
    function showSuccess(message) {
        successMessage.textContent = message;
        successAlert.classList.remove('d-none');
        errorAlert.classList.add('d-none');
    }
    
    function hideAlerts() {
        errorAlert.classList.add('d-none');
        successAlert.classList.add('d-none');
    }
    
    // Timer
    function updateTimer() {
        if (timeRemaining <= 0) {
            timerElement.textContent = 'Expired';
            timerElement.classList.add('expired');
            resendBtn.disabled = false;
            verifyBtn.disabled = true;
            clearInterval(timerInterval);
            return;
        }
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeRemaining <= 60) {
            timerElement.classList.add('warning');
        }
        
        timeRemaining--;
    }
    
    function startTimer() {
        updateTimer();
        timerInterval = setInterval(updateTimer, 1000);
    }
    
    // Start timer if OTP exists
    if ({{ 'true' if otp_status.exists else 'false' }}) {
        startTimer();
        resendBtn.disabled = timeRemaining > 480; // Enable resend after 2 minutes
    }
    
    // Form submission
    document.getElementById('otpForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const otp = getOTPValue();
        if (otp.length !== 6) {
            showError('Please enter all 6 digits');
            return;
        }
        
        hideAlerts();
        loadingIndicator.classList.remove('d-none');
        verifyBtn.disabled = true;
        
        fetch('/otp/verify', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                otp_type: '{{ otp_type }}',
                otp_code: otp,
                user_id: {{ user.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            loadingIndicator.classList.add('d-none');
            
            if (data.success) {
                showSuccess(data.message);
                
                // Redirect based on OTP type
                setTimeout(() => {
                    {% if otp_type == 'signup' %}
                        window.location.href = "{{ url_for('auth.login') }}?verified=1";
                    {% elif otp_type == 'login' %}
                        window.location.href = "{{ url_for('main.dashboard') }}";
                    {% elif otp_type == 'password_reset' %}
                        window.location.href = "{{ url_for('auth.reset_password') }}";
                    {% else %}
                        window.location.href = "{{ url_for('main.dashboard') }}";
                    {% endif %}
                }, 2000);
            } else {
                showError(data.message);
                clearOTP();
                verifyBtn.disabled = false;
            }
        })
        .catch(error => {
            loadingIndicator.classList.add('d-none');
            showError('An error occurred. Please try again.');
            verifyBtn.disabled = false;
        });
    });
    
    // Resend OTP
    resendBtn.addEventListener('click', function() {
        hideAlerts();
        resendBtn.disabled = true;
        
        fetch('/otp/resend', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                otp_type: '{{ otp_type }}',
                user_id: {{ user.id }}
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showSuccess(data.message);
                clearOTP();
                
                // Reset timer
                clearInterval(timerInterval);
                timeRemaining = 600; // 10 minutes
                timerElement.classList.remove('warning', 'expired');
                startTimer();
                
                // Re-enable resend after 2 minutes
                setTimeout(() => {
                    resendBtn.disabled = false;
                }, 120000);
            } else {
                showError(data.message);
                resendBtn.disabled = false;
            }
        })
        .catch(error => {
            showError('Failed to resend code. Please try again.');
            resendBtn.disabled = false;
        });
    });
    
    // Focus first input on load
    otpInputs[0].focus();
});
</script>
{% endblock %}
{% endblock %}