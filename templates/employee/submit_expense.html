{% extends "employee/layout.html" %}

{% block page_title %}Submit Expense{% endblock %}
{% block page_description %}Create a new expense submission{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto space-y-8">
    <div class="grid gap-4 md:grid-cols-3">
        <div class="card-3d rounded-xl p-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-green-500 to-emerald-600 rounded-lg flex items-center justify-center">
                    <i data-lucide="dollar-sign" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-400">Company Currency</p>
                    <p class="text-lg font-semibold text-white">{{ company_currency }}</p>
                </div>
            </div>
        </div>
        <div class="card-3d rounded-xl p-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-500 to-cyan-500 rounded-lg flex items-center justify-center">
                    <i data-lucide="calendar" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-400">Today's Date</p>
                    <p class="text-lg font-semibold text-white" id="todayDate"></p>
                </div>
            </div>
        </div>
        <div class="card-3d rounded-xl p-4">
            <div class="flex items-center space-x-3">
                <div class="w-10 h-10 bg-gradient-to-br from-purple-500 to-indigo-500 rounded-lg flex items-center justify-center">
                    <i data-lucide="info" class="w-5 h-5 text-white"></i>
                </div>
                <div>
                    <p class="text-xs uppercase tracking-wide text-slate-400">Need help?</p>
                    <p class="text-sm text-slate-300">Contact your manager if a category is missing.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card-3d rounded-2xl p-8">
        <header class="mb-8 space-y-2">
            <a href="{{ url_for('employee.expense_history') }}" class="inline-flex items-center gap-2 text-sm font-semibold text-cyan-300 transition hover:text-cyan-200">
                <span aria-hidden="true">←</span>
                Back to my expenses
            </a>
            <h1 class="text-3xl font-semibold tracking-tight text-white">Submit a new expense</h1>
            <p class="text-sm text-slate-400">Fill in the details below and we’ll notify your approver right away.</p>
        </header>

        <form method="POST" enctype="multipart/form-data" class="space-y-8" id="expenseForm">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

            <div class="grid gap-6 md:grid-cols-2">
                <div>
                    <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                        <span>Amount *</span>
                        <input type="number"
                               id="amount"
                               name="amount"
                               step="0.01"
                               min="0.01"
                               required
                               class="rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-slate-100 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/40"
                               placeholder="0.00">
                    </label>
                </div>
                <div>
                    <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                        <span>Currency *</span>
                        <select id="currency"
                                name="currency"
                                required
                                class="rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-slate-100 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/40">
                            <option value="">Select Currency</option>
                            {% for currency in currencies %}
                                <option value="{{ currency.code }}" {% if currency.code == company_currency %}selected{% endif %}>
                                    {{ currency.code }} - {{ currency.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </label>
                </div>
            </div>

            <div class="grid gap-6 md:grid-cols-2">
                <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                    <span>Category *</span>
                    <select id="category_id"
                            name="category_id"
                            required
                            class="rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-slate-100 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/40">
                        {% for category in categories %}
                            <option value="{{ category.id }}">{{ category.name }}</option>
                        {% endfor %}
                    </select>
                </label>
                <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                    <span>Expense Date *</span>
                    <input type="date"
                           id="date"
                           name="date"
                           required
                           class="rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-slate-100 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/40">
                </label>
            </div>

            <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                <span>Description *</span>
                <textarea id="description"
                          name="description"
                          rows="4"
                          maxlength="500"
                          required
                          class="rounded-lg border border-slate-800 bg-slate-950 px-3 py-2 text-slate-100 placeholder:text-slate-500 focus:border-cyan-400 focus:outline-none focus:ring-2 focus:ring-cyan-500/40"
                          placeholder="Provide a detailed description of this expense..."></textarea>
                <span class="text-xs text-slate-400"><span id="charCount">0</span>/500 characters</span>
            </label>

            <label class="flex flex-col gap-2 text-sm font-medium text-slate-200">
                <span>Receipt / Attachment (optional)</span>
                <div class="border-2 border-dashed border-slate-700/60 rounded-lg p-6 text-center hover:border-cyan-400/60 transition-colors duration-200">
                    <input type="file"
                           id="receipt"
                           name="receipt"
                           accept=".jpg,.jpeg,.png,.pdf,.doc,.docx"
                           class="hidden">
                    <div id="uploadArea" class="cursor-pointer">
                        <i data-lucide="upload" class="w-10 h-10 mx-auto text-slate-400 mb-3"></i>
                        <p class="text-slate-300 font-medium">Click to upload receipt</p>
                        <p class="text-sm text-slate-500">Supports JPG, PNG, PDF, DOC (max 10MB)</p>
                    </div>
                    <div id="filePreview" class="hidden">
                        <div class="flex items-center justify-center gap-3">
                            <i data-lucide="file" class="w-6 h-6 text-cyan-400"></i>
                            <div class="text-left">
                                <p id="fileName" class="text-slate-200 font-medium"></p>
                                <p id="fileSize" class="text-xs text-slate-400"></p>
                            </div>
                            <button type="button" id="removeFile" class="text-red-400 hover:text-red-300">
                                <i data-lucide="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </label>

            <div id="conversionPreview" class="hidden rounded-lg border border-green-500/30 bg-green-500/10 p-4">
                <div class="flex items-center gap-2">
                    <i data-lucide="refresh-cw" class="w-5 h-5 text-green-400"></i>
                    <span class="text-green-300 font-medium">Currency conversion preview</span>
                </div>
                <div class="mt-2 text-sm text-slate-300">
                    <span id="originalAmount"></span>
                    <span id="fromCurrency"></span>
                    =
                    <span id="convertedAmount" class="font-semibold text-green-300"></span>
                    <span id="toCurrency" class="font-semibold text-green-300"></span>
                    <div class="text-xs text-slate-400 mt-1">
                        Exchange rate: <span id="exchangeRate"></span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col-reverse sm:flex-row gap-4 pt-4">
                <a href="{{ url_for('employee.dashboard') }}"
                   class="btn-secondary inline-flex items-center justify-center rounded-lg px-6 py-3 text-sm font-semibold text-slate-300 hover:text-white">
                    <i data-lucide="arrow-left" class="w-4 h-4 mr-2"></i>
                    Back to dashboard
                </a>
                <button type="submit"
                        class="btn-primary inline-flex items-center justify-center rounded-lg px-6 py-3 text-sm font-semibold text-slate-900">
                    <i data-lucide="send" class="w-4 h-4 mr-2"></i>
                    Submit expense
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    const today = new Date();
    document.getElementById('todayDate').textContent = today.toLocaleDateString();
    document.getElementById('date').valueAsDate = today;

    const description = document.getElementById('description');
    const charCount = document.getElementById('charCount');
    description.addEventListener('input', () => {
        const count = description.value.length;
        charCount.textContent = count;
        charCount.classList.toggle('text-rose-300', count > 450);
    });

    const fileInput = document.getElementById('receipt');
    const uploadArea = document.getElementById('uploadArea');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFile = document.getElementById('removeFile');

    uploadArea.addEventListener('click', () => fileInput.click());

    fileInput.addEventListener('change', () => {
        const file = fileInput.files[0];
        if (!file) {
            return;
        }
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        uploadArea.classList.add('hidden');
        filePreview.classList.remove('hidden');
    });

    removeFile.addEventListener('click', () => {
        fileInput.value = '';
        uploadArea.classList.remove('hidden');
        filePreview.classList.add('hidden');
    });

    function formatFileSize(bytes) {
        if (!bytes) return '0 Bytes';
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const k = 1024;
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    const amountInput = document.getElementById('amount');
    const currencySelect = document.getElementById('currency');
    const conversionPreview = document.getElementById('conversionPreview');
    const originalAmount = document.getElementById('originalAmount');
    const fromCurrency = document.getElementById('fromCurrency');
    const convertedAmount = document.getElementById('convertedAmount');
    const toCurrency = document.getElementById('toCurrency');
    const exchangeRate = document.getElementById('exchangeRate');
    const companyCurrency = '{{ company_currency }}';
    let conversionTimeout;

    function updateConversionPreview() {
        const amount = parseFloat(amountInput.value);
        const currency = currencySelect.value;

        if (!amount || !currency || currency === companyCurrency) {
            conversionPreview.classList.add('hidden');
            return;
        }

        clearTimeout(conversionTimeout);
        conversionTimeout = setTimeout(() => {
            fetch('{{ url_for("employee.api_convert") }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    amount: amount,
                    from_currency: currency,
                    to_currency: companyCurrency
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    conversionPreview.classList.add('hidden');
                    return;
                }
                originalAmount.textContent = amount.toFixed(2);
                fromCurrency.textContent = currency;
                convertedAmount.textContent = data.converted_amount.toFixed(2);
                toCurrency.textContent = companyCurrency;
                exchangeRate.textContent = data.rate.toFixed(4);
                conversionPreview.classList.remove('hidden');
            })
            .catch(() => {
                conversionPreview.classList.add('hidden');
            });
        }, 400);
    }

    amountInput.addEventListener('input', updateConversionPreview);
    currencySelect.addEventListener('change', updateConversionPreview);
</script>
{% endblock %}