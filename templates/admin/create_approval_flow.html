{% extends "base.html" %}

{% block title %}Create Approval Flow{% endblock %}

{% block extra_css %}
<style>
    .step-item {
        border: 2px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        background: #f8f9fa;
        transition: all 0.3s;
    }
    .step-item:hover {
        border-color: #007bff;
        background: #ffffff;
    }
    .step-number {
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        margin-right: 1rem;
    }
    .flow-preview {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 10px;
        padding: 1.5rem;
    }
    .preview-step {
        background: rgba(255,255,255,0.1);
        border-radius: 6px;
        padding: 0.75rem;
        margin: 0.5rem 0;
        backdrop-filter: blur(10px);
    }
    .drag-handle {
        cursor: move;
        color: #6c757d;
    }
    .drag-handle:hover {
        color: #007bff;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">Create Approval Flow</h1>
                    <p class="text-muted">Design a custom expense approval workflow</p>
                </div>
                <a href="{{ url_for('admin.approval_flows') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Flows
                </a>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            <div class="card">
                <div class="card-body">
                    <form method="POST" id="createFlowForm">
                        <!-- Flow Basic Info -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-info-circle me-2"></i>Flow Information
                            </h6>
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="name" class="form-label">Flow Name *</label>
                                        <input type="text" class="form-control" id="name" name="name" 
                                               placeholder="e.g., Standard Expense Approval" required>
                                        <div class="form-text">Choose a descriptive name for this approval flow</div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">Flow Settings</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="is_default" name="is_default">
                                            <label class="form-check-label" for="is_default">
                                                Set as default flow
                                            </label>
                                        </div>
                                        <div class="form-text">New expenses will use this flow by default</div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Approval Steps -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center border-bottom pb-2 mb-3">
                                <h6 class="mb-0">
                                    <i class="fas fa-list-ol me-2"></i>Approval Steps
                                </h6>
                                <button type="button" class="btn btn-primary btn-sm" onclick="addStep()">
                                    <i class="fas fa-plus me-1"></i>Add Step
                                </button>
                            </div>

                            <div id="stepsContainer">
                                <!-- Initial step will be added by JavaScript -->
                            </div>

                            <div class="text-center mt-3">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Drag steps to reorder them. Each step must be completed before proceeding to the next.
                                </small>
                            </div>
                        </div>

                        <!-- Flow Templates -->
                        <div class="mb-4">
                            <h6 class="border-bottom pb-2 mb-3">
                                <i class="fas fa-magic me-2"></i>Quick Templates
                            </h6>
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="fas fa-user-check fa-2x text-primary mb-2"></i>
                                            <h6>Simple Approval</h6>
                                            <p class="small text-muted">Direct manager approval only</p>
                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                    onclick="loadTemplate('simple')">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="fas fa-users fa-2x text-success mb-2"></i>
                                            <h6>Two-Level Approval</h6>
                                            <p class="small text-muted">Manager + Finance approval</p>
                                            <button type="button" class="btn btn-outline-success btn-sm" 
                                                    onclick="loadTemplate('two-level')">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="card bg-light">
                                        <div class="card-body text-center">
                                            <i class="fas fa-building fa-2x text-warning mb-2"></i>
                                            <h6>Executive Approval</h6>
                                            <p class="small text-muted">Multi-level corporate approval</p>
                                            <button type="button" class="btn btn-outline-warning btn-sm" 
                                                    onclick="loadTemplate('executive')">Use Template</button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                                <i class="fas fa-eraser me-2"></i>Clear Form
                            </button>
                            <div>
                                <button type="button" class="btn btn-outline-info me-2" onclick="previewFlow()">
                                    <i class="fas fa-eye me-2"></i>Preview Flow
                                </button>
                                <a href="{{ url_for('admin.approval_flows') }}" class="btn btn-secondary me-2">Cancel</a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>Create Flow
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <!-- Flow Preview -->
            <div class="flow-preview mb-4">
                <h6 class="mb-3">
                    <i class="fas fa-eye me-2"></i>Flow Preview
                </h6>
                <div id="flowPreview">
                    <div class="text-center text-white-50">
                        <i class="fas fa-plus-circle fa-2x mb-2"></i>
                        <p>Add steps to see the flow preview</p>
                    </div>
                </div>
            </div>

            <!-- Help & Tips -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-lightbulb me-2"></i>Tips & Best Practices
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-primary">Step Configuration</h6>
                        <ul class="list-unstyled small">
                            <li class="mb-1">
                                <i class="fas fa-check text-success me-2"></i>
                                Use clear, descriptive step names
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-check text-success me-2"></i>
                                Set appropriate approval limits
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-check text-success me-2"></i>
                                Consider automatic approvals for small amounts
                            </li>
                        </ul>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-info">Flow Design</h6>
                        <ul class="list-unstyled small">
                            <li class="mb-1">
                                <i class="fas fa-arrow-right text-info me-2"></i>
                                Keep flows simple and efficient
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-arrow-right text-info me-2"></i>
                                Avoid too many approval levels
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-arrow-right text-info me-2"></i>
                                Test with sample expenses
                            </li>
                        </ul>
                    </div>

                    <div>
                        <h6 class="text-warning">Common Mistakes</h6>
                        <ul class="list-unstyled small">
                            <li class="mb-1">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                Creating circular approval loops
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                Missing required approvers
                            </li>
                            <li class="mb-1">
                                <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                                Overly complex approval paths
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Preview Modal -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Approval Flow Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="fullPreview"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let stepCounter = 0;

// Add initial step on page load
document.addEventListener('DOMContentLoaded', function() {
    addStep();
});

function addStep() {
    stepCounter++;
    const container = document.getElementById('stepsContainer');
    
    const stepHtml = `
        <div class="step-item" data-step="${stepCounter}">
            <div class="d-flex align-items-center mb-3">
                <span class="step-number">${stepCounter}</span>
                <div class="flex-grow-1">
                    <input type="text" class="form-control" 
                           name="steps[${stepCounter-1}][name]" 
                           placeholder="Step name (e.g., Manager Approval)" 
                           onchange="updatePreview()" required>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger ms-2" 
                        onclick="removeStep(this)" ${stepCounter === 1 ? 'disabled' : ''}>
                    <i class="fas fa-trash"></i>
                </button>
                <div class="drag-handle ms-2">
                    <i class="fas fa-grip-vertical"></i>
                </div>
            </div>
            
            <div class="row">
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Required Role</label>
                        <select class="form-select" name="steps[${stepCounter-1}][required_role]" onchange="updatePreview()">
                            <option value="">Any Role</option>
                            <option value="manager">Manager</option>
                            <option value="admin">Admin</option>
                            <option value="finance">Finance</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Approval Limit ($)</label>
                        <input type="number" class="form-control" 
                               name="steps[${stepCounter-1}][amount_limit]" 
                               placeholder="No limit" 
                               onchange="updatePreview()">
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="mb-3">
                        <label class="form-label">Auto-approve under</label>
                        <input type="number" class="form-control" 
                               name="steps[${stepCounter-1}][auto_approve]" 
                               placeholder="$0" 
                               onchange="updatePreview()">
                    </div>
                </div>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Step Description</label>
                <textarea class="form-control" rows="2" 
                          name="steps[${stepCounter-1}][description]" 
                          placeholder="Optional description of this approval step"
                          onchange="updatePreview()"></textarea>
            </div>
            
            <div class="form-check">
                <input class="form-check-input" type="checkbox" 
                       name="steps[${stepCounter-1}][can_skip]" 
                       id="canSkip${stepCounter}">
                <label class="form-check-label" for="canSkip${stepCounter}">
                    Allow skipping this step under certain conditions
                </label>
            </div>
        </div>
    `;
    
    container.insertAdjacentHTML('beforeend', stepHtml);
    updateStepNumbers();
    updatePreview();
}

function removeStep(button) {
    if (document.querySelectorAll('.step-item').length <= 1) {
        alert('At least one approval step is required.');
        return;
    }
    
    button.closest('.step-item').remove();
    updateStepNumbers();
    updatePreview();
}

function updateStepNumbers() {
    const steps = document.querySelectorAll('.step-item');
    steps.forEach((step, index) => {
        const stepNumber = step.querySelector('.step-number');
        stepNumber.textContent = index + 1;
        step.dataset.step = index + 1;
        
        // Update input names to maintain order
        const inputs = step.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (input.name) {
                input.name = input.name.replace(/\[\d+\]/, `[${index}]`);
            }
        });
        
        // Enable/disable remove button for first step
        const removeBtn = step.querySelector('.btn-outline-danger');
        removeBtn.disabled = index === 0;
    });
}

function updatePreview() {
    const previewContainer = document.getElementById('flowPreview');
    const steps = document.querySelectorAll('.step-item');
    
    if (steps.length === 0) {
        previewContainer.innerHTML = `
            <div class="text-center text-white-50">
                <i class="fas fa-plus-circle fa-2x mb-2"></i>
                <p>Add steps to see the flow preview</p>
            </div>
        `;
        return;
    }
    
    let previewHtml = '';
    steps.forEach((step, index) => {
        const name = step.querySelector('input[placeholder*="Step name"]').value || `Step ${index + 1}`;
        const role = step.querySelector('select').value || 'Any Role';
        const limit = step.querySelector('input[placeholder="No limit"]').value;
        
        previewHtml += `
            <div class="preview-step">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${index + 1}. ${name}</strong>
                        <br><small>Role: ${role.charAt(0).toUpperCase() + role.slice(1)}</small>
                    </div>
                    ${limit ? `<span class="badge bg-light text-dark">$${limit} limit</span>` : ''}
                </div>
            </div>
        `;
        
        if (index < steps.length - 1) {
            previewHtml += '<div class="text-center my-2"><i class="fas fa-arrow-down"></i></div>';
        }
    });
    
    previewContainer.innerHTML = previewHtml;
}

function loadTemplate(templateType) {
    // Clear existing steps
    document.getElementById('stepsContainer').innerHTML = '';
    stepCounter = 0;
    
    switch (templateType) {
        case 'simple':
            addStep();
            setTimeout(() => {
                document.querySelector('input[placeholder*="Step name"]').value = 'Manager Approval';
                document.querySelector('select').value = 'manager';
                updatePreview();
            }, 100);
            break;
            
        case 'two-level':
            addStep();
            addStep();
            setTimeout(() => {
                const steps = document.querySelectorAll('input[placeholder*="Step name"]');
                const selects = document.querySelectorAll('select');
                steps[0].value = 'Manager Approval';
                selects[0].value = 'manager';
                steps[1].value = 'Finance Approval';
                selects[1].value = 'finance';
                updatePreview();
            }, 100);
            break;
            
        case 'executive':
            addStep();
            addStep();
            addStep();
            setTimeout(() => {
                const steps = document.querySelectorAll('input[placeholder*="Step name"]');
                const selects = document.querySelectorAll('select');
                steps[0].value = 'Manager Approval';
                selects[0].value = 'manager';
                steps[1].value = 'Finance Review';
                selects[1].value = 'finance';
                steps[2].value = 'Executive Approval';
                selects[2].value = 'admin';
                updatePreview();
            }, 100);
            break;
    }
}

function previewFlow() {
    const flowName = document.getElementById('name').value || 'Untitled Flow';
    const isDefault = document.getElementById('is_default').checked;
    
    let previewHtml = `
        <div class="mb-3">
            <h5>${flowName} ${isDefault ? '<span class="badge bg-success">Default</span>' : ''}</h5>
        </div>
        <div class="flow-diagram">
    `;
    
    const steps = document.querySelectorAll('.step-item');
    steps.forEach((step, index) => {
        const name = step.querySelector('input[placeholder*="Step name"]').value || `Step ${index + 1}`;
        const role = step.querySelector('select').value || 'any';
        const description = step.querySelector('textarea').value;
        
        previewHtml += `
            <div class="card mb-3">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" 
                             style="width: 40px; height: 40px; font-weight: bold;">
                            ${index + 1}
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-1">${name}</h6>
                            <small class="text-muted">Required Role: ${role.charAt(0).toUpperCase() + role.slice(1)}</small>
                            ${description ? `<p class="mb-0 mt-1 small">${description}</p>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        if (index < steps.length - 1) {
            previewHtml += '<div class="text-center mb-3"><i class="fas fa-arrow-down fa-2x text-muted"></i></div>';
        }
    });
    
    previewHtml += '</div>';
    
    document.getElementById('fullPreview').innerHTML = previewHtml;
    const previewModal = new bootstrap.Modal(document.getElementById('previewModal'));
    previewModal.show();
}

function clearForm() {
    if (confirm('Are you sure you want to clear the form? All entered data will be lost.')) {
        document.getElementById('createFlowForm').reset();
        document.getElementById('stepsContainer').innerHTML = '';
        stepCounter = 0;
        addStep();
    }
}

// Form validation
document.getElementById('createFlowForm').addEventListener('submit', function(e) {
    const flowName = document.getElementById('name').value.trim();
    const steps = document.querySelectorAll('.step-item');
    
    if (!flowName) {
        e.preventDefault();
        alert('Please enter a flow name.');
        return;
    }
    
    if (steps.length === 0) {
        e.preventDefault();
        alert('Please add at least one approval step.');
        return;
    }
    
    // Check if all steps have names
    let hasEmptySteps = false;
    steps.forEach(step => {
        const stepName = step.querySelector('input[placeholder*="Step name"]').value.trim();
        if (!stepName) {
            hasEmptySteps = true;
        }
    });
    
    if (hasEmptySteps) {
        e.preventDefault();
        alert('Please provide names for all approval steps.');
        return;
    }
});
</script>
{% endblock %}